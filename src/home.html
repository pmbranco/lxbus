<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>LX Bus - Lisbon Bus Information</title>
        <link href='http://fonts.googleapis.com/css?family=Cantarell&subset=latin' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Molengo&subset=latin' rel='stylesheet' type='text/css'>
        <style type="text/css">
            body {
                background-color: #F0F0F0;
                text-align: center;
            }
            
            h1.logo {
                font-family: 'Cantarell';
                font-size: 7em;
            }
            
            p {
                font-family: sans-serif;
                font-size: 1.5em;
            }
            
            p.small {
                font-size: 0.8em;
            }
            
            div#main {
                margin-left: auto;
                margin-right: auto;
                width: 40%;
            }
            
            div#resultsdiv {
                display: none;
            }
			
			div#waitdiv {
				display: none;
			}
            
            span.yellow {
                color: #F5F373;
            }
            
            a:link {
                color: #206876;
                text-decoration: underline
            }
            
            a:visited {
                color: #206876;
                text-decoration: underline
            }
            
            a:active {
                color: #04859D;
                text-decoration: underline
            }
            
            a:hover {
                color: #015666;
                text-decoration: none
            }
        </style>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript">
        </script>
        <script type="text/javascript">
        	
			var LXBUS_OK_CODE = 0;
			
			var LXBUS_NO_BUSES = -1;
			var LXBUS_NO_INFO_RETURNED = -2;
			var LXBUS_NOT_YET_RETURNED = -3;
			
            receivePutReply = function(data){
                if (data.status_code < LXBUS_OK_CODE) {
                    alert("The server responded with an error. Please try again.");
                }
                else {
                    // Change interface and
					$("#inputdiv").hide();
					$("#waitdiv").show();

					// start polling the server in 5 seconds
                    setTimeout(updateRequestResult, 5 * 1000,data.requestid); 
                }
            };
			
			
            updateRequestResult = function(requestid){
                $.ajax({
                    url: '/api/updateBusRequest',
                    async: true,
                    ifModified: true,
                    data: {
                        requestid : requestid,
                    },
                    success: function(data, status, xhr){
                        if ((typeof data != 'undefined') && (data[0].statuscode != LXBUS_NOT_YET_RETURNED)) {
							
							returncode = data[0].statuscode
							
							$("#waitdiv").hide();
							
                            if (returncode < LXBUS_OK_CODE) {
								
								if(returncode == LXBUS_REPLY_NOBUSES)
								{
									$("#resultsmainp").text(data[0].message);
									
									$("#resultsdiv").show()
								} else {
									$("#inputdiv").show();
								}
								

                            } else {
								
								$("#resultsmainp").text(data[0].payload[0].dest)
								
								$("#resultsdiv").show();
                            }
                        } else {
                            // Try again in 5 seconds
                            setTimeout(updateRequestResult, 5 * 1000, requestid);
                        }
                    }
                })
            };
			
			
            putNewRequestFunc = function(stopcode){
                $.ajax({
                    url: '/api/newBusRequest',
                    async: true,
                    ifModified: true,
                    data: {
                        stopcode: stopcode,
                    },
                    success: function(data, status, xhr){
                        if (typeof data != 'undefined') {
							data = data[0]
                            receivePutReply(data);
                        }
                        else {
                            alert("Could not send a new request for a stopcode")
                        }
                    }
                })
            }
			
            $(document).ready(function(){
            
                $('#gobutton').click(function(event){
					
					if($("#stopcode").val() == "")
						alert("Please input a stop code")
					else					
                	{
						putNewRequestFunc($("#stopcode").val())
					}	
                });
                
            });
        </script>
    </head>
    <body>
        <div id="main">
            <h1 class="logo">LX<span class="yellow">Bus</span></h1>
			
			
            <div id="inputdiv">
                <input size="7" maxlength="7" type="text" name="stopcode" id="stopcode"/>
				<input type="button" id="gobutton" value="GO!" size="3"/>
                <p>
                    Write the stop code to get bus information about that bus stop.
                </p>
                <p class="small">
                    Stop codes can be obtained at the <a href="http://www.carris.pt/pt/informacao-ao-passageiro/">carris website</a>
                    or at the sign near the stop showing the buses that go through that stop. Usually this code starts with "C".
                </p>
            </div>
			
            <div id="resultsdiv">
                <p id="resultsmainp">
                    Results
                </p>
            </div>
			
            <div id="waitdiv">
                <p>
                    Please wait...<br />
                    <img src="/img/ajax-loader.gif">
                </p>
            </div>
			
            <p class="small">
                Developed by <a href="http://simaom.com/" target="_new">Sim√£o Mata</a>.
            </p>
        </div>
    </body>
</html>
